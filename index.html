<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday!</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js library for web audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Styles --- */
        :root {
            /* --- Updated Color Scheme v2 --- */
            --bg-color: #F8F6FF;         /* พื้นหลังหลัก */
            --primary-text: #8B5DFF;     /* ข้อความหลัก */
            --darker-text: #6A3ED4;      /* ข้อความเข้ม */
            --primary-accent: #B794F6;   /* สีเน้น/ดาว */
            --firework-color: #8B5DFF;   /* สีพลุ */
            --cake-light: #E6D8FF;       /* สีเค้กอ่อน */
            --cake-dark: #9B6BFF;        /* สีเค้กกลาง */
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html {
            font-size: 16px;
        }
        body {
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Kanit', sans-serif;
        }

        /* --- Page & Transition Styles --- */
        .page-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            opacity: 1;
            transition: opacity 1.5s ease-in-out, visibility 1.5s;
            visibility: visible;
            padding: 1rem;
        }
        .page-container.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        #fadeOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            opacity: 0;
            z-index: 9999;
            pointer-events: none;
            transition: opacity 1.5s ease-in-out;
        }
        #fadeOverlay.visible {
            opacity: 1;
        }
        
        /* --- Gate & Countdown Page --- */
        #page-gate, #page-countdown {
            background-color: var(--bg-color);
        }
        .pin-input {
            width: 50px; height: 60px; text-align: center; font-size: 2rem;
            border: 2px solid var(--primary-accent); border-radius: 0.5rem; margin: 0 0.25rem;
            background-color: #ffffff; color: var(--darker-text);
        }
        .pin-input:focus {
            outline: none; border-color: var(--primary-text);
            box-shadow: 0 0 0 3px rgba(139, 93, 255, 0.3);
        }
        .pin-input::-webkit-outer-spin-button, .pin-input::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        .pin-input[type=number] { 
            -moz-appearance: textfield; 
            appearance: textfield; /* เพิ่มบรรทัดนี้ */
        }
        #hintModal { background-color: rgba(0, 0, 0, 0.5); }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        .shake { animation: shake 0.5s ease-in-out; }

        /* --- Birthday Page --- */
        #page-birthday {
            font-family: 'Mitr', sans-serif;
            background-color: var(--bg-color);
        }
        #stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .star { position: absolute; background-color: var(--primary-accent); border-radius: 50%; animation: twinkle 2s infinite alternate; }
        @keyframes twinkle {
            0% { opacity: 0.4; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); box-shadow: 0 0 5px var(--primary-accent); }
        }
        #page-birthday .container { 
            text-align: center; position: relative; z-index: 10; opacity: 0; 
            width: 100%; max-width: 900px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            animation: fadeInUp 2s ease-out 0.5s forwards;
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(40px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .happy-text, .birthday-text { font-weight: 300; color: var(--primary-text); letter-spacing: 0.2em; margin-bottom: 0.5rem; min-height: 1.2em; }
        .happy-text { font-size: clamp(1.8rem, 7vw, 3.5rem); }
        .birthday-text { font-size: clamp(1.5rem, 5.5vw, 2.8rem); }
        .text-glow { animation: textGlow 1.5s ease-in-out infinite alternate; }
        @keyframes textGlow { from { text-shadow: 0 0 5px rgba(139, 93, 255, 0.5); } to { text-shadow: 0 0 10px rgba(139, 93, 255, 0.3); } }
        .cake-container { position: relative; margin: 0 auto; opacity: 0; height: 180px; width: 100%; max-width: 240px; overflow: hidden; animation: scaleIn 1s ease-out 2s forwards; }
        @keyframes scaleIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
        .cake { width: 100%; position: absolute; bottom: 20px; }
        .bottom-layer, .top-layer, .middle-layer { height: 48px; width: 144px; position: relative; margin: auto; background-repeat: repeat; background-size: 100% 100%, 36px 60px; background-position: 18px 0; background-image: linear-gradient( transparent 30px, var(--cake-light) 30px, var(--cake-light) 36px, transparent 36px ), radial-gradient(circle at 18px 3px, var(--cake-dark) 18px, var(--cake-light) 19px); }
        .middle-layer { transform: scale(0.85); top: 43px; animation: rise-1 2s forwards; }
        @keyframes rise-1 { 100% { top: 5px; } }
        .top-layer { transform: scale(0.7); top: 86px; animation: rise-2 2s 2s forwards; }
        @keyframes rise-2 { 100% { top: 16px; } }
        .candle { background: repeating-linear-gradient( 45deg, var(--cake-dark) 0, var(--cake-dark) 4px, var(--cake-light) 4px, var(--cake-light) 8px ); height: 27px; width: 9px; position: absolute; margin: auto; left: 0; right: 0; bottom: 0; animation: rise-3 1s 4s forwards; }
        @keyframes rise-3 { 100% { bottom: 121px; } }
        .candle:after { content: ""; position: absolute; height: 10px; width: 10px; background-color: #ffee54; border-radius: 0 50% 50% 50%; transform: scale(0) rotate(45deg); bottom: 30px; left: -0.5px; animation: flame 1.5s 5s forwards; transition: all 0.3s ease-out; }
        @keyframes flame { 100% { transform: scale(1) rotate(45deg); } }
        .candle.blown-out:after { transform: scale(0) rotate(45deg) !important; opacity: 0; }
        .candle:before { content: ""; position: absolute; width: 6px; height: 11px; background: var(--primary-accent); border-radius: 50%; opacity: 0; filter: blur(3px); bottom: 34px; left: 50%; transform: translateX(-50%); }
        .candle.blown-out:before { animation: smokePuff 1.5s ease-out forwards; }
        @keyframes smokePuff { 0% { opacity: 0.6; transform: translateX(-50%) translateY(0) scale(0.5); } 100% { opacity: 0; transform: translateX(-50%) translateY(-30px) scale(1.5); } }
        .action-button { font-size: clamp(1rem, 2.5vw, 1.2rem); font-weight: 500; color: white; margin-top: 1rem; position: relative; display: inline-block; background: var(--primary-text); border: 3px solid var(--primary-text); border-radius: 50px; padding: 10px 20px; cursor: pointer; box-shadow: 0 8px 25px rgba(139, 93, 255, 0.4); opacity: 0; pointer-events: none; transform: translateY(20px); transition: all 0.8s ease; }
        .action-button.visible { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .action-button:hover { transform: translateY(-5px); box-shadow: 0 12px 35px rgba(106, 62, 212, 0.6); background: var(--darker-text); }
        .action-button:active { transform: translateY(-2px); }
        .wishes, .thai-message { color: var(--primary-text); }
        .wishes { font-size: clamp(0.9rem, 3vw, 1.3rem); font-weight: 300; letter-spacing: 0.1em; opacity: 0; margin-bottom: 0.5rem; animation: fadeIn 1s ease-out 2.5s forwards; }
        .thai-message { font-size: clamp(1rem, 3.5vw, 1.5rem); font-weight: 400; letter-spacing: 0.05em; opacity: 0; min-height: 2.5em; animation: fadeIn 1s ease-out 3s forwards; }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        
        /* --- Countdown & Start Page Text Color --- */
        #page-countdown h1, #page-start h1 {
            color: var(--primary-text);
        }
        #page-start #readyButton {
            background-color: var(--primary-text);
        }
        #page-start #readyButton:hover {
            background-color: var(--darker-text);
        }

        /* --- Gate Page Text & Button Colors --- */
        #page-gate h1 {
            color: var(--darker-text);
        }
        #confirmButton {
            background-color: var(--primary-text);
        }
        #confirmButton:hover {
            background-color: var(--darker-text);
        }
        #hintButton {
            background-color: var(--primary-accent);
        }
        #hintButton:hover {
            background-color: var(--primary-text);
        }
        
        /* --- Responsive Adjustments --- */
        @media (max-width: 480px) {
            .balloon-container { display: none; } 
        }

        @media (min-width: 768px) and (orientation: landscape), (min-width: 1024px) {
            #page-birthday .container {
                transform: scale(0.75); 
            }
        }
    </style>
</head>
<body>
    <!-- Overlay for page transitions -->
    <div id="fadeOverlay"></div>

    <!-- ===== 1. Countdown Page ===== -->
    <div id="page-countdown" class="page-container">
         <div class="text-center">
            <h1 id="countdownText" class="text-4xl sm:text-5xl md:text-7xl font-bold hidden"></h1>
            <button id="startCountdownButton" class="text-white font-bold py-3 px-8 sm:py-4 sm:px-10 rounded-full text-lg sm:text-xl md:text-2xl active:scale-95 transition-all duration-200 shadow-lg" style="background-color: var(--primary-text);" onmouseover="this.style.backgroundColor='var(--darker-text)'" onmouseout="this.style.backgroundColor='var(--primary-text)'">เริ่ม</button>
        </div>
    </div>

    <!-- ===== 2. Birthday Page ===== -->
    <div id="page-birthday" class="page-container hidden">
        <canvas id="fireworks-canvas" style="position:absolute; top:0; left:0; z-index: 5; pointer-events: none;"></canvas>
        <div id="stars-container"></div>
        <div class="container">
            <div class="birthday-wrapper">
                <div class="happy-text"></div>
                <div class="birthday-text"></div>
            </div>
            <div class="cake-container">
                <div class="cake">
                  <div class="candle"></div>
                  <div class="top-layer"></div>
                  <div class="middle-layer"></div>
                  <div class="bottom-layer"></div>
                </div>
            </div>
            <div class="wishes"></div>
            <div class="thai-message"></div>
            <div class="action-button" id="actionButton"></div>
        </div>
    </div>

    <!-- ===== 3. Start Page ("Are you ready?") ===== -->
    <div id="page-start" class="page-container hidden">
        <div class="text-center">
            <h1 class="text-4xl sm:text-5xl md:text-7xl font-bold mb-8">พร้อมไหม</h1>
            <button id="readyButton" class="text-white font-bold py-3 px-8 sm:py-4 sm:px-10 rounded-full text-lg sm:text-xl md:text-2xl active:scale-95 transition-all duration-200 shadow-lg">พร้อม</button>
        </div>
    </div>

    <!-- ===== 4. Gate Page (Password) ===== -->
    <div id="page-gate" class="page-container hidden">
        <div class="text-center">
            <h1 class="text-3xl md:text-5xl font-bold mb-6">ถ้าพร้อมแล้วว โปรดใส่รหัส</h1>
            <div id="pin-container" class="flex justify-center mb-8">
                <input type="number" maxlength="1" class="pin-input" oninput="this.value=this.value.slice(0,1)">
                <input type="number" maxlength="1" class="pin-input" oninput="this.value=this.value.slice(0,1)">
                <input type="number" maxlength="1" class="pin-input" oninput="this.value=this.value.slice(0,1)">
                <input type="number" maxlength="1" class="pin-input" oninput="this.value=this.value.slice(0,1)">
            </div>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <button id="hintButton" class="text-white font-bold py-3 px-8 rounded-full text-lg active:scale-95 transition-all duration-200 shadow-md w-full sm:w-auto">คำใบ้จ้าาา</button>
                <button id="confirmButton" class="text-white font-bold py-3 px-8 rounded-full text-lg active:scale-95 transition-all duration-200 shadow-md w-full sm:w-auto">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- Hint Modal -->
    <div id="hintModal" class="fixed inset-0 z-[10000] items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4" style="background-color: var(--bg-color); border: 2px solid var(--primary-accent);">
            <p id="hintText" class="text-2xl font-bold" style="color: var(--darker-text);"></p>
            <button id="closeModalButton" class="mt-6 text-white font-bold py-2 px-6 rounded-full text-lg active:scale-95 transition-all duration-200" style="background-color: var(--primary-text);" onmouseover="this.style.backgroundColor='var(--darker-text)'" onmouseout="this.style.backgroundColor='var(--primary-text)'">ปิด</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // =================================================================
            // --- CONFIGURATION ---
            // =================================================================
            const CONFIG = {
                correctPin: "1811",
                hintText: "อยู่ในกล่องของขวัญนะจ๊ะ",
                countdownDuration: 3, // seconds
                songDuration: 30, // seconds - play only first 30 seconds
                fadeOutDuration: 3000, // milliseconds
                messages: {
                    happy: "HAPPY",
                    birthday: "BIRTHDAY",
                    wish: "Make a wish and celebrate!",
                    thai: "มีความสุขมากๆนะครับ",
                    blowCandle: "เป่าเทียน",
                    goNext: "ไปต่อ"
                },
                fireworkColor: getComputedStyle(document.documentElement).getPropertyValue('--firework-color').trim(),
                starCount: 30
            };

            // =================================================================
            // --- PAGE & ELEMENT REFERENCES ---
            // =================================================================
            const pages = {
                countdown: document.getElementById('page-countdown'),
                birthday: document.getElementById('page-birthday'),
                start: document.getElementById('page-start'),
                gate: document.getElementById('page-gate')
            };
            const fadeOverlay = document.getElementById('fadeOverlay');
            const actionButton = document.getElementById('actionButton');
            const readyButton = document.getElementById('readyButton');
            const confirmButton = document.getElementById('confirmButton');
            const hintButton = document.getElementById('hintButton');
            const modal = document.getElementById('hintModal');
            const closeModalButton = document.getElementById('closeModalButton');
            const hintTextElement = document.getElementById('hintText');
            const countdownTextElement = document.getElementById('countdownText');
            const startCountdownButton = document.getElementById('startCountdownButton');
            const pinContainer = document.getElementById('pin-container');
            const pinInputs = document.querySelectorAll('.pin-input');
            const fireworksCanvas = document.getElementById('fireworks-canvas');
            const ctx = fireworksCanvas.getContext('2d');

            // =================================================================
            // --- STATE MANAGEMENT ---
            // =================================================================
            let interactionState = 'blow_candle'; // 'blow_candle' or 'go_next'
            let countdownTimer = CONFIG.countdownDuration;
            let rockets = [];
            let particles = [];
            let confetti = [];
            let explosionHasStarted = false;
            let animationRunning = false;
            let musicFadeInterval = null;
            let musicStartTime = 0;
            let isAudioReady = false;

            // =================================================================
            // --- TONE.JS AUDIO SETUP ---
            // =================================================================
            
            // Create a reverb effect for a softer, more atmospheric sound
            const reverb = new Tone.Reverb({
                decay: 4,
                preDelay: 0.01,
                wet: 0.3
            }).toDestination();

            // Create a synthesizer with a softer, "cuter" tone
            const synth = new Tone.PolySynth(Tone.FMSynth, {
                harmonicity: 3.01,
                modulationIndex: 10,
                envelope: {
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.2,
                    release: 1.5
                },
                modulationEnvelope: {
                    attack: 0.01,
                    decay: 0.5,
                    sustain: 0.1,
                    release: 1.5
                }
            }).connect(reverb);

            // Set volume to 50%
            synth.volume.value = -6; // -6dB is approximately 50% volume

            // Define the Happy Birthday melody
            const melodyNotes = [
                // "Happy birthday to you"
                { time: '0:0', note: 'D4', duration: '8n' },
                { time: '0:0.5', note: 'D4', duration: '8n' },
                { time: '0:1', note: 'E4', duration: '4n' },
                { time: '0:2', note: 'D4', duration: '4n' },
                { time: '1:0', note: 'G4', duration: '4n' },
                { time: '1:1', note: 'F#4', duration: '2n' },

                // "Happy birthday to you"
                { time: '2:0', note: 'D4', duration: '8n' },
                { time: '2:0.5', note: 'D4', duration: '8n' },
                { time: '2:1', note: 'E4', duration: '4n' },
                { time: '2:2', note: 'D4', duration: '4n' },
                { time: '3:0', note: 'A4', duration: '4n' },
                { time: '3:1', note: 'G4', duration: '2n' },

                // "Happy birthday dear..."
                { time: '4:0', note: 'D4', duration: '8n' },
                { time: '4:0.5', note: 'D4', duration: '8n' },
                { time: '4:1', note: 'D5', duration: '4n' },
                { time: '4:2', note: 'B4', duration: '4n' },
                { time: '5:0', note: 'G4', duration: '4n' },
                { time: '5:1', note: 'F#4', duration: '4n' },
                { time: '5:2', note: 'E4', duration: '2n' },

                // "Happy birthday to you"
                { time: '6:1', note: 'C5', duration: '8n' },
                { time: '6:1.5', note: 'C5', duration: '8n' },
                { time: '6:2', note: 'B4', duration: '4n' },
                { time: '7:0', note: 'G4', duration: '4n' },
                { time: '7:1', note: 'A4', duration: '4n' },
                { time: '7:2', note: 'G4', duration: '2n' },
            ];

            // Create a Tone.Part to schedule the notes
            const melodyPart = new Tone.Part((time, value) => {
                synth.triggerAttackRelease(value.note, value.duration, time);
            }, melodyNotes).start(0);
            melodyPart.loop = true;
            melodyPart.loopEnd = '8m';

            // Configure the transport
            Tone.Transport.bpm.value = 100;

            // =================================================================
            // --- AUDIO FUNCTIONS ---
            // =================================================================
            
            async function startBackgroundMusic() {
                try {
                    if (!isAudioReady) {
                        await Tone.start();
                        isAudioReady = true;
                        console.log('Audio context started');
                    }
                    
                    // Set master volume to 50%
                    Tone.Destination.volume.value = -6; // -6dB is approximately 50% volume
                    
                    if (Tone.Transport.state !== 'started') {
                        Tone.Transport.start();
                        musicStartTime = Date.now();
                        console.log('Melody started at 50% volume');
                    }
                } catch (error) {
                    console.log('Audio setup failed:', error);
                }
            }
            
            function fadeOutMusic() {
                if (musicFadeInterval) {
                    clearInterval(musicFadeInterval);
                }
                
                const startVolume = Tone.Destination.volume.value;
                const fadeStep = Math.abs(startVolume + 60) / (CONFIG.fadeOutDuration / 50); // Fade from current to -60dB
                
                musicFadeInterval = setInterval(() => {
                    const currentVolume = Tone.Destination.volume.value;
                    const newVolume = Math.max(-60, currentVolume - fadeStep);
                    Tone.Destination.volume.value = newVolume;
                    
                    if (newVolume <= -60) {
                        stopBackgroundMusic();
                        clearInterval(musicFadeInterval);
                        musicFadeInterval = null;
                    }
                }, 50);
            }
            
            function stopBackgroundMusic() {
                if (musicFadeInterval) {
                    clearInterval(musicFadeInterval);
                    musicFadeInterval = null;
                }
                Tone.Transport.stop();
                Tone.Destination.volume.value = -6; // Reset to 50% volume for next time
                console.log('Melody stopped');
            }

            // =================================================================
            // --- EVENT LISTENERS ---
            // =================================================================
            
            actionButton.addEventListener('click', function() {
                if (interactionState === 'blow_candle') {
                    handleBlowCandle();
                } else if (interactionState === 'go_next') {
                    fadeOutMusic(); // Start fading out music in background
                    transitionTo('start'); // Immediately transition without waiting
                }
            });

            readyButton.addEventListener('click', () => transitionTo('gate'));
            
            confirmButton.addEventListener('click', handlePinConfirm);

            startCountdownButton.addEventListener('click', () => {
                startCountdownButton.classList.add('hidden');
                countdownTextElement.classList.remove('hidden');
                updateCountdown();
            });

            pinInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value.length === 1 && index < pinInputs.length - 1) {
                        pinInputs[index + 1].focus();
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                        pinInputs[index - 1].focus();
                    }
                });
            });

            hintButton.addEventListener('click', () => { 
                hintTextElement.textContent = CONFIG.hintText;
                modal.classList.remove('hidden'); 
                modal.classList.add('flex'); 
            });
            closeModalButton.addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex'); });
            modal.addEventListener('click', (e) => { if (e.target === modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }});
            
            window.addEventListener('resize', debounceResize);

            // =================================================================
            // --- CORE FUNCTIONS ---
            // =================================================================

            function transitionTo(targetPageId) {
                fadeOverlay.classList.add('visible');
                setTimeout(() => {
                    Object.values(pages).forEach(page => page.classList.add('hidden'));
                    pages[targetPageId].classList.remove('hidden');
                    
                    if (targetPageId === 'birthday') {
                        startBirthdayPageAnimations();
                        startBackgroundMusic(); // Start Tone.js melody when entering birthday page
                    }
                    if (targetPageId === 'gate') {
                        pinInputs.forEach(input => input.value = '');
                        pinInputs[0].focus();
                    }
                    if (targetPageId === 'countdown') resetAndStartCountdown();

                    setTimeout(() => fadeOverlay.classList.remove('visible'), 100);
                }, 1500);
            }

            function handleBlowCandle() {
                explosionHasStarted = false; 
                document.querySelector('.candle').classList.add('blown-out'); 
                
                launchFireworkFromPosition(window.innerWidth * 0.2);
                launchFireworkFromPosition(window.innerWidth * 0.5);
                launchFireworkFromPosition(window.innerWidth * 0.8);
                
                // Start confetti after a short delay
                setTimeout(() => {
                    createConfetti();
                }, 500);
                
                setTimeout(() => {
                    const pos1 = 0.35;
                    const pos2 = 0.65;
                    launchFireworkFromPosition(window.innerWidth * pos1);
                    launchFireworkFromPosition(window.innerWidth * pos2);
                }, 1000);
                
                actionButton.classList.remove('visible');
                setTimeout(() => {
                    actionButton.textContent = CONFIG.messages.goNext;
                    actionButton.classList.add('visible');
                    interactionState = 'go_next';
                }, 3500);
            }

            function handlePinConfirm() {
                const enteredPin = Array.from(pinInputs).map(input => input.value).join('');
                if (enteredPin === CONFIG.correctPin) {
                    transitionTo('countdown');
                } else {
                    pinContainer.classList.add('shake');
                    pinInputs.forEach(input => input.value = '');
                    pinInputs[0].focus();
                    setTimeout(() => pinContainer.classList.remove('shake'), 500);
                }
            }

            function updateCountdown() {
                if (countdownTimer >= 0) {
                    countdownTextElement.textContent = countdownTimer > 0 ? `จะเริ่มใน ${countdownTimer} วินาที` : 'เริ่ม!';
                    countdownTimer--;
                    setTimeout(updateCountdown, 1100);
                } else {
                    transitionTo('birthday');
                }
            }
            
            function resetAndStartCountdown() {
                countdownTimer = CONFIG.countdownDuration;
                // Show button and hide countdown text initially
                startCountdownButton.classList.remove('hidden');
                countdownTextElement.classList.add('hidden');
            }

            // =================================================================
            // --- ANIMATION & VISUALS ---
            // =================================================================

            function startBirthdayPageAnimations() {
                document.querySelector('.wishes').textContent = CONFIG.messages.wish;
                document.querySelector('.thai-message').textContent = CONFIG.messages.thai;

                createStars();
                
                setTimeout(() => {
                    const happyText = document.querySelector('.happy-text');
                    const birthdayText = document.querySelector('.birthday-text');
                    typeWriter(happyText, CONFIG.messages.happy, 150, () => {
                        typeWriter(birthdayText, CONFIG.messages.birthday, 150, () => {
                            happyText.classList.add('text-glow');
                            birthdayText.classList.add('text-glow');
                        });
                    });
                }, 1000);

                setTimeout(() => {
                    actionButton.textContent = CONFIG.messages.blowCandle;
                    actionButton.classList.add('visible');
                }, 7000);
            }

            function typeWriter(element, text, speed, callback) {
                let i = 0;
                element.innerHTML = '';
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, speed);
                    } else if (callback) callback();
                }
                type();
            }

            function createStars() {
                const container = document.getElementById('stars-container');
                if (container.children.length > 0) return;
                for (let i = 0; i < CONFIG.starCount; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    const size = Math.random() * 2 + 1;
                    star.style.width = `${size}px`; star.style.height = `${size}px`;
                    star.style.top = `${Math.random() * 100}%`; star.style.left = `${Math.random() * 100}%`;
                    star.style.animationDelay = `${Math.random() * 2}s`;
                    star.style.animationDuration = `${Math.random() * 2 + 1}s`;
                    container.appendChild(star);
                }
            }

            // --- Canvas Fireworks Section ---
            function resizeCanvas() {
                fireworksCanvas.width = window.innerWidth;
                fireworksCanvas.height = window.innerHeight;
            }

            class Rocket {
                constructor(x, y) {
                    this.x = x; 
                    this.y = window.innerHeight * 0.85; // Start at 15% from bottom
                    this.targetY = window.innerHeight * 0.3 + Math.random() * (window.innerHeight * 0.1);
                    this.speed = 6;
                }
                update() {
                    this.y -= this.speed;
                    return this.y <= this.targetY;
                }
                draw() {
                    ctx.globalAlpha = 1;
                    ctx.fillStyle = CONFIG.fireworkColor;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            class Particle {
                constructor(x, y) {
                    this.x = x; this.y = y;
                    this.vx = (Math.random() - 0.5) * 4;
                    this.vy = (Math.random() - 0.5) * 4;
                    this.life = 35;
                    this.maxLife = 35;
                    this.size = 2;
                    this.gravity = 0.03;
                    this.friction = 0.995;
                }
                update() {
                    this.vx *= this.friction; this.vy *= this.friction;
                    this.vy += this.gravity;
                    this.x += this.vx; this.y += this.vy;
                    this.life--;
                }
                draw() {
                    ctx.globalAlpha = this.life / this.maxLife;
                    ctx.fillStyle = CONFIG.fireworkColor;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            class Confetti {
                constructor() {
                    this.x = Math.random() * window.innerWidth;
                    this.y = -10;
                    this.vx = (Math.random() - 0.5) * 2;
                    this.vy = Math.random() * 2 + 1;
                    this.rotation = Math.random() * 360;
                    this.rotationSpeed = (Math.random() - 0.5) * 10;
                    this.size = Math.random() * 8 + 4;
                    this.colors = ['#8B5DFF', '#B794F6', '#E6D8FF', '#9B6BFF', '#FFD700', '#FF69B4'];
                    this.color = this.colors[Math.floor(Math.random() * this.colors.length)];
                    this.life = 100;
                    this.gravity = 0.1;
                    this.friction = 0.99;
                }
                
                update() {
                    this.vy += this.gravity;
                    this.vx *= this.friction;
                    this.x += this.vx;
                    this.y += this.vy;
                    this.rotation += this.rotationSpeed;
                    this.life--;
                }
                
                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation * Math.PI / 180);
                    ctx.fillStyle = this.color;
                    ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
                    ctx.restore();
                }
            }

            function createConfetti() {
                // Create limited confetti particles to avoid lag
                for (let i = 0; i < 30; i++) {
                    setTimeout(() => {
                        confetti.push(new Confetti());
                    }, i * 50); // Stagger creation
                }
            }

            function createExplosion(x, y) {
                const particleCount = 50;
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle(x, y));
                }
            }

            function launchFireworkFromPosition(x) {
                rockets.push(new Rocket(x));
                if (!animationRunning) {
                    animationRunning = true;
                    animateFireworks();
                }
            }

            function animateFireworks() {
                if (rockets.length === 0 && particles.length === 0 && confetti.length === 0) {
                    animationRunning = false;
                    return;
                }

                ctx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
                
                // Update and draw rockets
                for (let i = rockets.length - 1; i >= 0; i--) {
                    const rocket = rockets[i];
                    rocket.draw();
                    if (rocket.update()) {
                        createExplosion(rocket.x, rocket.y);
                        rockets.splice(i, 1);
                        explosionHasStarted = true;
                    }
                }
                
                // Update and draw particles
                for (let i = particles.length - 1; i >= 0; i--) {
                    const particle = particles[i];
                    particle.update();
                    particle.draw();
                    if (particle.life <= 0) {
                        particles.splice(i, 1);
                    }
                }
                
                // Update and draw confetti
                for (let i = confetti.length - 1; i >= 0; i--) {
                    const piece = confetti[i];
                    piece.update();
                    piece.draw();
                    if (piece.y > window.innerHeight + 20 || piece.life <= 0) {
                        confetti.splice(i, 1);
                    }
                }
                
                requestAnimationFrame(animateFireworks);
            }

            // Debounced resize function
            let resizeTimeout;
            function debounceResize() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(resizeCanvas, 100);
            }

            // =================================================================
            // --- INITIALIZATION ---
            // =================================================================
            function init() {
                resizeCanvas();
                // Start with the countdown page
                Object.values(pages).forEach(page => page.classList.add('hidden'));
                pages.countdown.classList.remove('hidden');
                resetAndStartCountdown();
            }

            init();

        });
    </script>
</body>
</html>

